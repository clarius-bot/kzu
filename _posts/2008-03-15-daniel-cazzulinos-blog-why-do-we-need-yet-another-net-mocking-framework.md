---
layout: post
title: "Daniel Cazzulino's Blog : Why do we need yet another NET mocking framework"
date: 2008-03-15 00:00:00 +0000
---

Daniel Cazzulino's Blog : Why do we need yet another NET mocking framework

### Search

[Go](javascript:__doPostBack\('_ctl0$_ctl0$_ctl0$_ctl0$BlogSideBar1$_ctl0$Singleweblogsearch1$_ctl0$SearchButton',''\))

### Subscriptions

  * [RSS 2.0](http://www.clariusconsulting.net/blogs/kzu/rss.aspx)
  * [Atom 0.3](http://www.clariusconsulting.net/blogs/kzu/atom.aspx)
  * [Contact](http://www.clariusconsulting.net/blogs/kzu/contact.aspx)

| [<](javascript:__doPostBack\('_ctl0$_ctl0$_ctl0$_ctl0$BlogSideBar1$_ctl0$Cal$_ctl0$PostCalendar','V3013'\))| May 2008| [>](javascript:__doPostBack\('_ctl0$_ctl0$_ctl0$_ctl0$BlogSideBar1$_ctl0$Cal$_ctl0$PostCalendar','V3074'\))  
---|---|---  
Su| Mo| Tu| We| Th| Fr| Sa  
27| 28| 29| 30| 1| 2| [3](http://www.clariusconsulting.net/blogs/kzu/archive/2008/3/3.aspx "1 Post")  
4| [5](http://www.clariusconsulting.net/blogs/kzu/archive/2008/3/5.aspx "1 Post")| 6| 7| 8| 9| [10](http://www.clariusconsulting.net/blogs/kzu/archive/2008/3/10.aspx "1 Post")  
11| 12| [13](http://www.clariusconsulting.net/blogs/kzu/archive/2008/3/13.aspx "2 Posts")| 14| 15| 16| [17](http://www.clariusconsulting.net/blogs/kzu/archive/2008/3/17.aspx "1 Post")  
18| [19](http://www.clariusconsulting.net/blogs/kzu/archive/2008/3/19.aspx "1 Post")| 20| 21| 22| 23| [24](http://www.clariusconsulting.net/blogs/kzu/archive/2008/3/24.aspx "1 Post")  
25| 26| 27| 28| 29| 30| 31  
1| 2| 3| 4| 5| 6| 7  
  
[![Microsoft MVP Profile](https://web.archive.org/web/20080508023029im_/http://clariusconsulting.net/Themes/default/images/mvp-logo.gif)](http://aspnet2.com/mvp.ashx?kzu)

### News

[![](https://web.archive.org/web/20080508023029im_/http://www.feedburner.com/fb/images/pub/feed-icon16x16.png)](http://feeds.feedburner.com/DanielCazzulino) [](http://feeds.feedburner.com/DanielCazzulino) [![](https://web.archive.org/web/20080508023029im_/http://feeds.feedburner.com/~fc/DanielCazzulino?bg=FF6600&fg=FFFFFF&anim=1)](http://feeds.feedburner.com/DanielCazzulino)

[ ![](/web/20080508023029im_/http://www.clariusconsulting.net/img/mail-to-button.gif) Contact](http://www.clariusconsulting.net/blogs/kzu/contact.aspx)

### Post Categories

  * [.NET](http://www.clariusconsulting.net/blogs/kzu/archive/category/1023.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1023)
  * [All Technology](http://www.clariusconsulting.net/blogs/kzu/archive/category/1035.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1035)
  * [ASP.NET](http://www.clariusconsulting.net/blogs/kzu/archive/category/1024.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1024)
  * [Books](http://www.clariusconsulting.net/blogs/kzu/archive/category/1022.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1022)
  * [GAT](http://www.clariusconsulting.net/blogs/kzu/archive/category/1038.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1038)
  * [InSTEDD](http://www.clariusconsulting.net/blogs/kzu/archive/category/1064.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1064)
  * [Mesh](http://www.clariusconsulting.net/blogs/kzu/archive/category/1065.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1065)
  * [Miscelaneous](http://www.clariusconsulting.net/blogs/kzu/archive/category/1026.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1026)
  * [Moq](http://www.clariusconsulting.net/blogs/kzu/archive/category/1062.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1062)
  * [Movies](http://www.clariusconsulting.net/blogs/kzu/archive/category/1027.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1027)
  * [Patterns & Practices](http://www.clariusconsulting.net/blogs/kzu/archive/category/1037.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1037)
  * [PowerShell](http://www.clariusconsulting.net/blogs/kzu/archive/category/1055.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1055)
  * [Shadowfax](http://www.clariusconsulting.net/blogs/kzu/archive/category/1032.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1032)
  * [Software Factories](http://www.clariusconsulting.net/blogs/kzu/archive/category/1041.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1041)
  * [WPF](http://www.clariusconsulting.net/blogs/kzu/archive/category/1060.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1060)
  * [XML](http://www.clariusconsulting.net/blogs/kzu/archive/category/1021.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1021)

## Why do we need yet another NET mocking framework 

I got this question a couple times in the past MIX08 at Las Vegas. And this is a very valid question indeed, given that there's already [Rhino](http://www.mockframeworks.com/rhino), [EasyMock](http://www.mockframeworks.com/easymock), [TypeMock](http://www.mockframeworks.com/typemock) and [NMock](http://www.mockframeworks.com/nmock) (to name a few). So why did we give you Moq?

One possible answer would be to start with a checklist of what Moq offers that others don't in terms of supported features. That would be a mistake, though, as it could be easily argued that a better choice would have been to contribute to an already established opensource framework that accepted community contributions.

There's one fundamental reason why there are a variety of frameworks/libraries that do similar things throughout the opensource space: more choices mean more freedom to pick the one that best suits your unique sense of style, simplicity, flexibility, etc. So, when I hear the question, I immediately think about it in the opposite terms: why not?

The value we think Moq brings to the community is simplicity through a more natural programming model.

## Status-quo

When I look at a [Rhino Mocks quickstart](http://orand.blogspot.com/2007/12/rhino-mocks-quick-reference.html) and read about its "3 different record/replay syntax styles, 4 types of mocks, 7 if you include MultiMocks...", I can't help but think that it's far from ideal for any newcomer. The situation doesn't seem to be significantly better in other .NET mock frameworks with similar range of features.

I've already argued in the past why I think forcing regular developers to learn and understand [the difference between a stub, a fake, a "true" mock and a dynamic mock is unproductive and largely irrelevant](http://www.clariusconsulting.net/blogs/kzu/archive/2007/12/21/47152.aspx) for their TDD needs.

Also, even though [quite common in the mocking community](http://ayende.com/Blog/archive/2007/12/26/The-RecordReplayVerify-model.aspx), the [typical record/replay model is alien to developers](http://www.clariusconsulting.net/blogs/kzu/archive/2007/12/26/48177.aspx) and introduces yet another new concept that makes the learning curve steeper than needed. 

On top of this situation, along came C# 3.0 with some amazing language features that could be put to use to significantly increase the usability and elegance of any mocking framework.

## Back to basics with Moq

The first thing we did was spike the simplest possible framework in order to assess the benefits and potential cost of development. We were blown away with my friend [Juan ](http://weblogs.manas.com.ar/waj/)when we got the basics (expectations, return values, callbacks and throwing exceptions) working after a mere 2 hours of intense pairing. We saw the clear benefits of a simpler API, as well as the sheer beauty of C# 3.0 lambda expressions applied to mocks.

In Moq, there's exactly *one* API to learn: [Mock<T>](http://www.clariusconsulting.net/labs/moq/html/98C52E48.htm). Creating a mock is no different than creating any other object:
    
    
    mock = new Mock<ICommand>();

[](http://11011.net/software/vspaste)[](http://11011.net/software/vspaste)

There's no record/reply model to learn, no static calls on hard-to-discover classes, etc. For the most part, you don't even need to read the documentation at all (although it [has extensive code documentation complete with code samples](http://www.clariusconsulting.net/labs/moq/index.html)), because using the various features is generally one "dot" away from your mock instance:
    
    
    mock.Expect(command => command.Execute("ping"));
    

[](http://11011.net/software/vspaste)[](http://11011.net/software/vspaste)

Basically the expectation is a lambda that can represent an invocation to a void method or to a value-returning one. The lambda argument (such as `command` above) is automatically inferred to be of the type of the mock (the `T` argument when you create it). 

Intellisense integration combined with the fluent API goes a long way in helping you figure out your next steps once you have an expectation. For example, the `ICommand.Execute` method returns a string, and therefore, one "dot" away you have the options for the corresponding expectation:

![image](/web/20080508023029im_/http://www.clariusconsulting.net/images/blogs/kzu/Whydoweneedanothermockingframework_123CF/image.png)

Let's say that you change the expectation to be an invocation to another method which is void, instead (changing Execute to Undo in this case):

![image](/web/20080508023029im_/http://www.clariusconsulting.net/images/blogs/kzu/Whydoweneedanothermockingframework_123CF/image_3.png)

Note how the available options have changed now. There's no more [Returns](http://www.clariusconsulting.net/labs/moq/html/3757D5F.htm), as the method has nothing to return now. [Callback](http://www.clariusconsulting.net/labs/moq/html/43540AB1.htm) is still available, like [Throws](http://www.clariusconsulting.net/labs/moq/html/F90A87B2.htm). Note, however, that [AtMostOnce](http://www.clariusconsulting.net/labs/moq/html/202FA61A.htm) and [Verifiable](http://www.clariusconsulting.net/labs/moq/html/C43EFEAB.htm) were not available before. That's because before you can set occurrence or verification constraints, the first thing you need to do for a non-void method expectation is specify whether you'll return a value or throw an exception. But you didn't need to know the proper sequence of invocation ahead of time: intellisense guided you automatically.

As the invocation progresses, the fluent API will guide you through the remaining options. Let's say in the previous example you specify that an exception will be thrown for an empty command:

![image](/web/20080508023029im_/http://www.clariusconsulting.net/images/blogs/kzu/Whydoweneedanothermockingframework_123CF/image_4.png)

Because you have already specified that the mock will throw an exception, you can no longer specify a return value, which is natural, of course. Now you can only specify the ocurrence and verification options for the expectation, if you so wish to. And if you specified that the given method with the empty argument can be called at most once, now your options will narrow even more:

![image](/web/20080508023029im_/http://www.clariusconsulting.net/images/blogs/kzu/Whydoweneedanothermockingframework_123CF/image_5.png)

As you can see, learning to use the API is mostly about using it and "dotting" into the created mock. Note we're using the [trick I mentioned in my previous post to streamline the intellisense experience](http://www.clariusconsulting.net/blogs/kzu/archive/2008/03/10/58301.aspx).

Note how the specifics of the theoretical difference between stubs, fakes and mocks are completely absent. They are irrelevant to the average developer, so we don't surface it in the API either. What you typically care about when you work with test aids (or [test doubles](http://www.martinfowler.com/bliki/TestDouble.html)) is whether you want each and every invocation made to it to have a corresponding expectation (i.e. it is "strict") or some grades of flexibility (i.e. it only throws for abstract members invocations, or only when a return value is needed, or even never unless you specify so). That's a more natural model, and it's surfaced in the API as a constructor argument for the mock:

![image](/web/20080508023029im_/http://www.clariusconsulting.net/images/blogs/kzu/Whydoweneedanothermockingframework_123CF/image_6.png)

The various [MockBehavior](http://www.clariusconsulting.net/labs/moq/html/90760C57.htm) options control the mock behavior when an invocation is performed on it without a previously defined corresponding expectation. This way you can easily change how strict or loose it will be.

### Mock Verification

Mock verification may be optional depending on your mocking style. I'm myself a classicist, and we realized many people are. In fact, the "strictness" of some mock frameworks and the kind of "smell" they introduce by overly tying expectations and verifications to concrete implementation details of interactions is one of the first arguments classicists (I can hear my friend [Peter Provost](http://www.peterprovost.org/)...) will bring up when talking about the "drawbacks" of using mock frameworks.

As such, we made mock verification completely optional and very granular. You can [verify only the expectations you want to verify](http://www.clariusconsulting.net/labs/moq/html/E9CC3712.htm) (those marked as [Verifiable](http://www.clariusconsulting.net/labs/moq/html/C43EFEAB.htm)), or you can verify an entire mock (with [VerifyAll](http://www.clariusconsulting.net/labs/moq/html/604FBEC0.htm)). 

In case you need consistent mock behavior and verification, you can opt to use the [MockFactory](http://www.clariusconsulting.net/labs/moq/html/4C85C26D.htm) if you want to.

### Mock Reuse

In typical unit tests, your reusable objects live in test class fields that you initialize at test setup and cleanup on tear down. It's quite common to have default behavior associated with mocks, and being able to reuse these expectations can make your tests much more concise:
    
    
    [TestFixture]
    public class Demo
    {
        Mock<ICommand> mock;
    
        [SetUp]
        public void SetUp()
        {
            mock = new Mock<ICommand>();
            mock.Expect(command => command.Execute(""))
                .Throws(new ArgumentException());
            mock.Expect(command => command.Execute(null))
                .Throws(new ArgumentNullException());
        }
    
        [Test]
        public void Run()
        {
            // We can reuse the default expectations for null or empty commands 
            mock.Expect(command => command.Execute("ping"))
                .Returns(true);
    
            // pass this mock to other components 
            // that may call "ping" and check for the 
            // return value true.
        }
    }
    

[](http://11011.net/software/vspaste)[](http://11011.net/software/vspaste)

To make reuse even more flexible and compelling, you can actually override a default expectation in a specific unit test by just re-defining it. 

You can also place calls to [Verify](http://www.clariusconsulting.net/labs/moq/html/E9CC3712.htm) or [VerifyAll](http://www.clariusconsulting.net/labs/moq/html/604FBEC0.htm) on the test tear down method to have consistent verification if that's what you need.

These features take away one of the typical complaints: that using mock frameworks typically make your unit tests too verbose and obscure the true purpose of the test behind somewhat unrelated expectations that have to be set just to hook everything together. Now you can move all that repetitive code (and typically expensive to fix when implementation details change) to the fixture setup, and have a central place to maintain when interactions change.

posted on Monday, March 17, 2008 8:51 AM by [kzu](http://www.clariusconsulting.net/user/Profile.aspx?UserID=1004)

[Post a Comment](http://www.clariusconsulting.net/blogs/kzu/comments/58442.aspx) :: 

#### [#](http://www.clariusconsulting.net/blogs/kzu/archive/2008/03/17/WhydoweneedyetanotherNETmockingframework.aspx#58443 "permalink") Why do we need yet another .NET mocking framework? @ Saturday, March 15, 2008 9:41 AM

I got this question a couple times in the past MIX08 at Las Vegas. And this is a very valid question [](javascript:__doPostBack\('_ctl0$_ctl0$_ctl0$_ctl0$_ctl0$_ctl0$Comments$_ctl0$Comments$_ctl0$EditLink',''\))

[Anonymous](http://www.clariusconsulting.net/utility/Redirect.aspx?U=http://weblogs.asp.net/cazzu/archive/2008/03/15/why-do-we-need-yet-another-net-mocking-framework.aspx "TrackBack")

#### [#](http://www.clariusconsulting.net/blogs/kzu/archive/2008/03/17/WhydoweneedyetanotherNETmockingframework.aspx#58946 "permalink") Moq: Why do we need yet another NET mocking framework? @ Tuesday, March 25, 2008 8:30 AM

You've been kicked (a good thing) - Trackback from DotNetKicks.com [](javascript:__doPostBack\('_ctl0$_ctl0$_ctl0$_ctl0$_ctl0$_ctl0$Comments$_ctl0$Comments$_ctl1$EditLink',''\))

[Anonymous](http://www.clariusconsulting.net/utility/Redirect.aspx?U=http://www.dotnetkicks.com/unittesting/Moq_Why_do_we_need_yet_another_NET_mocking_framework "TrackBack")

#### [#](http://www.clariusconsulting.net/blogs/kzu/archive/2008/03/17/WhydoweneedyetanotherNETmockingframework.aspx#59090 "permalink") Garage Door Hardware @ Tuesday, April 01, 2008 9:50 PM

Many of the sites that come up in the search engines just don\'t have exactly what you need. This one does. [](javascript:__doPostBack\('_ctl0$_ctl0$_ctl0$_ctl0$_ctl0$_ctl0$Comments$_ctl0$Comments$_ctl2$EditLink',''\))

[Anonymous](http://www.clariusconsulting.net/utility/Redirect.aspx?U=http://www.shopforgarages.com/steelgaragedoor.html "TrackBack")

  

[![](/web/20080508023029im_/http://www.clariusconsulting.net/Themes/default/images/hdr-KZU.jpg)](http://clariusconsulting.net/blogs "Clarius Aggregated Blogs")