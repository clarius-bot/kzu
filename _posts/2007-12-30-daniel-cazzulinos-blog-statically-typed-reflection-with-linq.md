---
layout: post
title: "Daniel Cazzulino's Blog : Statically-typed reflection with LINQ"
date: 2007-12-30 00:00:00 +0000
---

Daniel Cazzulino's Blog : Statically-typed reflection with LINQ

### Search

[Go](javascript:__doPostBack\('_ctl0$_ctl0$_ctl0$_ctl0$BlogSideBar1$_ctl0$Singleweblogsearch1$_ctl0$SearchButton',''\))

### Subscriptions

  * [RSS 2.0](http://www.clariusconsulting.net/blogs/kzu/rss.aspx)
  * [Atom 0.3](http://www.clariusconsulting.net/blogs/kzu/atom.aspx)
  * [Contact](http://www.clariusconsulting.net/blogs/kzu/contact.aspx)

| [<](javascript:__doPostBack\('_ctl0$_ctl0$_ctl0$_ctl0$BlogSideBar1$_ctl0$Cal$_ctl0$PostCalendar','V2982'\))| April 2008| [>](javascript:__doPostBack\('_ctl0$_ctl0$_ctl0$_ctl0$BlogSideBar1$_ctl0$Cal$_ctl0$PostCalendar','V3043'\))  
---|---|---  
Su| Mo| Tu| We| Th| Fr| Sa  
30| 31| 1| 2| 3| 4| 5  
6| 7| 8| 9| 10| 11| 12  
13| 14| 15| 16| 17| [18](http://www.clariusconsulting.net/blogs/kzu/archive/2007/12/18.aspx "1 Post")| 19  
20| [21](http://www.clariusconsulting.net/blogs/kzu/archive/2007/12/21.aspx "2 Posts")| 22| 23| 24| 25| [26](http://www.clariusconsulting.net/blogs/kzu/archive/2007/12/26.aspx "2 Posts")  
[27](http://www.clariusconsulting.net/blogs/kzu/archive/2007/12/27.aspx "1 Post")| 28| 29| [30](http://www.clariusconsulting.net/blogs/kzu/archive/2007/12/30.aspx "1 Post")| 1| 2| 3  
4| 5| 6| 7| 8| 9| 10  
  
[![Microsoft MVP Profile](https://web.archive.org/web/20080415103855im_/http://clariusconsulting.net/Themes/default/images/mvp-logo.gif)](http://aspnet2.com/mvp.ashx?kzu)

### News

[![](https://web.archive.org/web/20080415103855im_/http://www.feedburner.com/fb/images/pub/feed-icon16x16.png)](http://feeds.feedburner.com/DanielCazzulino) [](http://feeds.feedburner.com/DanielCazzulino) [![](https://web.archive.org/web/20080415103855im_/http://feeds.feedburner.com/~fc/DanielCazzulino?bg=FF6600&fg=FFFFFF&anim=1)](http://feeds.feedburner.com/DanielCazzulino)

[ ![](/web/20080415103855im_/http://www.clariusconsulting.net/img/mail-to-button.gif) Contact](http://www.clariusconsulting.net/blogs/kzu/contact.aspx)

### Post Categories

  * [.NET](http://www.clariusconsulting.net/blogs/kzu/archive/category/1023.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1023)
  * [All Technology](http://www.clariusconsulting.net/blogs/kzu/archive/category/1035.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1035)
  * [ASP.NET](http://www.clariusconsulting.net/blogs/kzu/archive/category/1024.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1024)
  * [Books](http://www.clariusconsulting.net/blogs/kzu/archive/category/1022.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1022)
  * [GAT](http://www.clariusconsulting.net/blogs/kzu/archive/category/1038.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1038)
  * [InSTEDD](http://www.clariusconsulting.net/blogs/kzu/archive/category/1064.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1064)
  * [Miscelaneous](http://www.clariusconsulting.net/blogs/kzu/archive/category/1026.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1026)
  * [Moq](http://www.clariusconsulting.net/blogs/kzu/archive/category/1062.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1062)
  * [Movies](http://www.clariusconsulting.net/blogs/kzu/archive/category/1027.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1027)
  * [Patterns & Practices](http://www.clariusconsulting.net/blogs/kzu/archive/category/1037.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1037)
  * [PowerShell](http://www.clariusconsulting.net/blogs/kzu/archive/category/1055.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1055)
  * [Shadowfax](http://www.clariusconsulting.net/blogs/kzu/archive/category/1032.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1032)
  * [Software Factories](http://www.clariusconsulting.net/blogs/kzu/archive/category/1041.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1041)
  * [WPF](http://www.clariusconsulting.net/blogs/kzu/archive/category/1060.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1060)
  * [XML](http://www.clariusconsulting.net/blogs/kzu/archive/category/1021.aspx) [(rss)](http://www.clariusconsulting.net/blogs/kzu/rss.aspx?CategoryID=1021)

## Statically-typed reflection with LINQ 

Quite some time ago I posted about [how to use LINQ to provide a strong-typed reflection API](http://www.clariusconsulting.net/blogs/kzu/archive/2006/07/06/TypedReflection.aspx). I used a very old LINQ preview back then. 

With [.NET 3.5 and C# 3.0 released](http://www.microsoft.com/downloads/details.aspx?FamilyID=333325fd-ae52-4e35-b531-508d977d32a6&displaylang=en) now, it was time for an update. As part of the update, I also improved the API a little bit. Usage now is:
    
    
    				MethodInfo toString = Reflect<object>.GetMethod(x => x.ToString());

[ ](http://11011.net/software/vspaste)

The renamed `Reflect<TTarget>` class receives the type you want to reflect as a generic parameter. Then you can use `GetMethod`, `GetField` or `GetProperty`.

Other examples:
    
    
    				MethodInfo clone = Reflect<ICloneable>.GetMethod(x => x.Clone());
    
    PropertyInfo prop = Reflect<AppDomain>.GetProperty(x => x.BaseDirectory);
    
    FieldInfo field = Reflect<Mock>.GetField(x => x.PublicField);
    

[ ](http://11011.net/software/vspaste)

Working principle is the same: the lambda you pass to the methods is actually an expression which I analyze to retrieve the underlying reflection object that is already exposed by the LINQ Expression API. For example, once you get to a [MethodCallExpression](http://msdn2.microsoft.com/en-us/library/system.linq.expressions.methodcallexpression.aspx), you can get the method being called through its [Method](http://msdn2.microsoft.com/en-us/library/bb340973.aspx) property:
    
    
    ((MethodCallExpression)lambda.Body).Method;

It's interesting to see how this works actually, and what's the compiler generating for those lambda expressions invoking methods.

In Reflector, the following C# code:

MethodInfo clone = Reflect<ICloneable>.GetMethod(x => x.Clone()); 

is decompiled as (indented for readability): 
    
    
    				ParameterExpression CS$0$0000;
    MethodInfo clone = Reflect<ICloneable>.GetMethod(  
    Expression.Lambda<Action<ICloneable>>(  
    Expression.Call(  
          CS$0$0000 = Expression.Parameter(typeof(ICloneable), "x"),   
          (MethodInfo) methodof(ICloneable.Clone),   
    new Expression[0]  
        ),   
    new ParameterExpression[] { CS$0$0000 }  
      )  
    );

[ ](http://11011.net/software/vspaste)

Note how the MethodInfo is retrieved directly from the interface by using a `methodof` operator. It's not a valid C# keyword, but given that [Lutz Roeder](http://www.aisto.com/roeder/) works for Microsoft (not on the C# team, though), let's hope it will get eventually in the language :). 

That `methodof` translation is actually the conversion from the following two IL lines:
    
    
    L_0017: ldtoken instance object [mscorlib]System.ICloneable::Clone()  
    L_001c: call class [mscorlib]System.Reflection.MethodBase [mscorlib]System.Reflection.MethodBase::GetMethodFromHandle(valuetype [mscorlib]System.RuntimeMethodHandle)
    

`ldtoken` is the key there, let's hope it gets promoted to C# in some way eventually.

Anyway, since I wrote my original article, I realized through [Ayende's blog](http://www.ayende.com/Blog/Default.aspx) that you can also do [static reflection without LINQ](http://www.ayende.com/Blog/archive/2005/10/29/8176.aspx). It only works for methods though, and you cannot use the lambda syntax because it results in method infos that are actually from a compiler-generated type (the one that contains the closures too if any). 

As I'm so in love with the lambda syntax, I'll keep my implementation based on expression trees instead of delegates.

It's released now as part of [Clarius Labs](http://www.codeplex.com/clarius) projects. [Get the source](https://www.codeplex.com/Release/ProjectReleases.aspx?ProjectName=clarius&ReleaseId=9495) and have fun!

[****[License: Microsoft Permissive License (Ms-PL) v1.1](http://www.codeplex.com/clarius/Project/License.aspx)]

posted on Sunday, December 30, 2007 11:45 AM by [kzu](http://www.clariusconsulting.net/user/Profile.aspx?UserID=1004)

[Post a Comment](http://www.clariusconsulting.net/blogs/kzu/comments/49063.aspx) :: 

#### [#](http://www.clariusconsulting.net/blogs/kzu/archive/2007/12/30/49063.aspx#49081 "permalink") Strong-typed reflection with LINQ @ Sunday, December 30, 2007 12:11 PM

Quite some time ago I posted about how to use LINQ to provide a strong-typed reflection API . I used [](javascript:__doPostBack\('_ctl0$_ctl0$_ctl0$_ctl0$_ctl0$_ctl0$Comments$_ctl0$Comments$_ctl0$EditLink',''\))

[Anonymous](http://www.clariusconsulting.net/utility/Redirect.aspx?U=http://weblogs.asp.net/cazzu/archive/2007/12/30/strong-typed-reflection-with-linq.aspx "TrackBack")

#### [#](http://www.clariusconsulting.net/blogs/kzu/archive/2007/12/30/49063.aspx#49345 "permalink") Strong-typed reflection with LINQ @ Monday, December 31, 2007 10:54 AM

Bookmarked your post over at Blog Bookmarker.com! [](javascript:__doPostBack\('_ctl0$_ctl0$_ctl0$_ctl0$_ctl0$_ctl0$Comments$_ctl0$Comments$_ctl1$EditLink',''\))

[Anonymous](http://www.clariusconsulting.net/utility/Redirect.aspx?U=http://www.blogbookmarker.com/tags/permissive "TrackBack")

#### [#](http://www.clariusconsulting.net/blogs/kzu/archive/2007/12/30/49063.aspx#49392 "permalink") Static Reflection using Expression Trees @ Monday, December 31, 2007 4:35 PM

Static Reflection using Expression Trees [](javascript:__doPostBack\('_ctl0$_ctl0$_ctl0$_ctl0$_ctl0$_ctl0$Comments$_ctl0$Comments$_ctl2$EditLink',''\))

[Anonymous](http://www.clariusconsulting.net/utility/Redirect.aspx?U=http://chadmyers.com/Blog/archive/2007/12/31/static-reflection-using-expression-trees.aspx "TrackBack")

#### [#](http://www.clariusconsulting.net/blogs/kzu/archive/2007/12/30/49063.aspx#50512 "permalink") Statically-typed reflection with LINQ @ Saturday, January 05, 2008 8:26 PM

Bookmarked your post over at Blog Bookmarker.com! [](javascript:__doPostBack\('_ctl0$_ctl0$_ctl0$_ctl0$_ctl0$_ctl0$Comments$_ctl0$Comments$_ctl3$EditLink',''\))

[Anonymous](http://www.clariusconsulting.net/utility/Redirect.aspx?U=http://www.blogbookmarker.com/tags/permissive "TrackBack")

#### [#](http://www.clariusconsulting.net/blogs/kzu/archive/2007/12/30/49063.aspx#55287 "permalink") Statically-typed reflection with LINQ @ Sunday, February 03, 2008 8:52 AM

You've been kicked (a good thing) - Trackback from DotNetKicks.com [](javascript:__doPostBack\('_ctl0$_ctl0$_ctl0$_ctl0$_ctl0$_ctl0$Comments$_ctl0$Comments$_ctl4$EditLink',''\))

[Anonymous](http://www.clariusconsulting.net/utility/Redirect.aspx?U=http://www.dotnetkicks.com/linq/Statically_typed_reflection_with_LINQ "TrackBack")

  

[![](/web/20080415103855im_/http://www.clariusconsulting.net/Themes/default/images/hdr-KZU.jpg)](http://clariusconsulting.net/blogs "Clarius Aggregated Blogs")